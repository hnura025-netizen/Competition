<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Race: Player vs AI</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px #000; }
        .speed { font-size: 2.5rem; font-weight: 800; color: #00ffcc; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="speed"><span id="speedo">0</span> KM/H</div>
        <div>W/A/S/D or Arrows to Drive</div>
        <div id="status">RACE START!</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'cannon-es';

        // --- WORLD SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333344);
        scene.fog = new THREE.Fog(0x333344, 10, 100);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82, 0) });

        // --- LIGHTING ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(10, 50, 10);
        scene.add(sun);

        // --- TRACK & ROAD ---
        // Visual Road
        const roadGeom = new THREE.PlaneGeometry(20, 2000);
        const roadMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
        const road = new THREE.Mesh(roadGeom, roadMat);
        road.rotation.x = -Math.PI / 2;
        scene.add(road);

        // Physics Ground
        const groundBody = new CANNON.Body({ type: CANNON.Body.STATIC, shape: new CANNON.Plane() });
        groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
        world.addBody(groundBody);

        // --- VEHICLE CREATOR FUNCTION ---
        function createVehicle(color, startPos) {
            const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2));
            const chassisBody = new CANNON.Body({ mass: 150 });
            chassisBody.addShape(chassisShape);
            chassisBody.position.copy(startPos);
            
            const v = new CANNON.RaycastVehicle({
                chassisBody,
                indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2
            });

            // Add wheels logic
            const wheelOptions = {
                radius: 0.5, directionLocal: new CANNON.Vec3(0, -1, 0),
                suspensionStiffness: 30, suspensionRestLength: 0.3,
                frictionSlip: 1.4, axleLocal: new CANNON.Vec3(-1, 0, 0),
                chassisConnectionPointLocal: new CANNON.Vec3(0,0,0)
            };

            const positions = [
                new CANNON.Vec3(1, -0.2, 1.5), new CANNON.Vec3(-1, -0.2, 1.5),
                new CANNON.Vec3(1, -0.2, -1.5), new CANNON.Vec3(-1, -0.2, -1.5)
            ];

            positions.forEach(p => {
                wheelOptions.chassisConnectionPointLocal.copy(p);
                v.addWheel(wheelOptions);
            });
            v.addToWorld(world);

            const group = new THREE.Group();
            const bodyMesh = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({ color }));
            group.add(bodyMesh);
            scene.add(group);

            return { v, body: chassisBody, mesh: group };
        }

        // --- SPAWN RACERS ---
        const player = createVehicle(0xff0000, new CANNON.Vec3(3, 1, 0));
        const opponents = [
            createVehicle(0x0066ff, new CANNON.Vec3(-3, 1, 10)),
            createVehicle(0x0066ff, new CANNON.Vec3(0, 1, 20))
        ];

        // --- INPUTS ---
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        // --- MAIN LOOP ---
        function update() {
            requestAnimationFrame(update);
            world.fixedStep();

            // 1. Player Control
            const force = 1000;
            const steer = 0.5;
            player.v.applyEngineForce((keys['KeyW'] || keys['ArrowUp']) ? -force : ((keys['KeyS'] || keys['ArrowDown']) ? force : 0), 2);
            player.v.applyEngineForce((keys['KeyW'] || keys['ArrowUp']) ? -force : ((keys['KeyS'] || keys['ArrowDown']) ? force : 0), 3);
            
            const sVal = (keys['KeyA'] || keys['ArrowLeft']) ? steer : ((keys['KeyD'] || keys['ArrowRight']) ? -steer : 0);
            player.v.setSteeringValue(sVal, 0);
            player.v.setSteeringValue(sVal, 1);

            // 2. AI Control (Simple: just drive forward)
            opponents.forEach(opp => {
                opp.v.applyEngineForce(-800, 2);
                opp.v.applyEngineForce(-800, 3);
            });

            // 3. Sync Visuals
            [player, ...opponents].forEach(car => {
                car.mesh.position.copy(car.body.position);
                car.mesh.quaternion.copy(car.body.quaternion);
            });

            // 4. Camera
            const camOffset = new THREE.Vector3(0, 4, 12).applyQuaternion(player.mesh.quaternion);
            camera.position.copy(player.mesh.position).add(camOffset);
            camera.lookAt(player.mesh.position);

            document.getElementById('speedo').innerText = Math.floor(player.body.velocity.length() * 3.6);
            
            renderer.render(scene, camera);
        }

        update();
    </script>
</body>
</html>
